import streamlit as st
import google.generativeai as genai

# -------------------------
# Page setup
# -------------------------
st.set_page_config(page_title="AI –ï–∫–æ-–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç", page_icon="üå±", layout="wide")

# -------------------------
# API key
# -------------------------
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("–õ–∏–ø—Å–≤–∞ API –∫–ª—é—á. –ú–æ–ª—è, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≥–æ –≤ Streamlit Secrets.")
    st.stop()

# -------------------------
# Specialties (all required)
# -------------------------
SPECIALTIES = [
    "–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –∏ –∫–æ–º–ø—é—Ç—ä—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏",
    "–ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞ –∏ –∑–µ–º–µ–¥–µ–ª—Å–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∞",
    "–ö–æ–º–ø—é—Ç—ä—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –∏ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏–∏",
    "–ï–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞",
    "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –Ω–∞ —Ö—Ä–∞–Ω–∏—Ç–µ",
    "–¢–æ–ø–ª–æ- –∏ –≥–∞–∑–æ—Å–Ω–∞–±–¥—è–≤–∞–Ω–µ",
    "–ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª–Ω–æ –∏–Ω–∂–µ–Ω–µ—Ä—Å—Ç–≤–æ",
    "–î–∏–∑–∞–π–Ω, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∏ –º–µ–Ω–∏–¥–∂–º—ä–Ω—Ç –Ω–∞ –º–æ–¥–Ω–∞—Ç–∞ –∏–Ω–¥—É—Å—Ç—Ä–∏—è",
]

# -------------------------
# System prompt
# -------------------------
SYSTEM_PROMPT = """
–¢–∏ —Å–∏ EcoAI ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª/–∫–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç –ø–æ –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∞ –ï–∫–æ–ª–æ–≥–∏—è –≤—ä–≤ –§–∞–∫—É–ª—Ç–µ—Ç ‚Äû–¢–µ—Ö–Ω–∏–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏‚Äú ‚Äì –Ø–º–±–æ–ª.
–¶–µ–ª—Ç–∞ —Ç–∏ –µ –¥–∞ –∫–æ–Ω—Å—É–ª—Ç–∏—Ä–∞—à —Å—Ç—É–¥–µ–Ω—Ç –∫–∞–∫ –¥–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∏ –∞—Å–ø–µ–∫—Ç–∏ –∏ ‚ÄûGreen‚ÄìDigital Transition‚Äú –≤ –∏–Ω–∂–µ–Ω–µ—Ä–µ–Ω –ø—Ä–æ–µ–∫—Ç.

–ö–†–ò–¢–ò–ß–ù–ò –ü–†–ê–í–ò–õ–ê:
- –í–∏–Ω–∞–≥–∏ —Å–µ —Å—ä–æ–±—Ä–∞–∑—è–≤–∞–π —Å—ä—Å —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç—Ç–∞, –∫–æ—è—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç—ä—Ç –µ –∏–∑–±—Ä–∞–ª. –û—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ —Ç–∏ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏ –∑–∞ —Ç–æ–∑–∏ –¥–æ–º–µ–π–Ω.
- –í—ä–≤ –≤—Å–µ–∫–∏ –æ—Ç–≥–æ–≤–æ—Ä —Å–ª–µ–¥–≤–∞–π —è—Å–Ω–∞, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–∞ —Ñ–æ—Ä–º–∞ —Å –∫—Ä–∞—Ç–∫–∏ bullets (–∏–∑–±—è–≥–≤–∞–π –¥—ä–ª–≥–∏ –∞–±–∑–∞—Ü–∏; –∏–∑–ø–æ–ª–∑–≤–∞–π –ø–æ–¥—Ç–æ—á–∫–∏ –ø—Ä–∏ –Ω—É–∂–¥–∞).
- –ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ –æ—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ 500‚Äì800 –¥—É–º–∏ (–∫—Ä–∞—Ç–∫–æ –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ).
  –†–∞–∑—à–∏—Ä—è–≤–∞–π —Å–∞–º–æ –∞–∫–æ —Å—Ç—É–¥–µ–Ω—Ç—ä—Ç –∏–∑—Ä–∏—á–Ω–æ –ø–æ–∏—Å–∫–∞ ‚Äû–ø–æ-–ø–æ–¥—Ä–æ–±–Ω–æ‚Äú, ‚Äû–ø–æ–¥—Ä–æ–±–Ω–∞ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è‚Äú, ‚Äû—Ä–∞–∑—à–∏—Ä–∏‚Äú, ‚Äû–¥–∞–π –ø–æ–≤–µ—á–µ –¥–µ—Ç–∞–π–ª–∏‚Äú –∏ —Ç.–Ω.
- –ú–æ–∂–µ—à –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—à –∫–∞–∫—Ç–æ –∑–Ω–∞–Ω–∏—è –æ—Ç –∫—É—Ä—Å–∞, —Ç–∞–∫–∞ –∏ –≤—ä–Ω—à–Ω–∏ –Ω–∞–¥–µ–∂–¥–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏ (–Ω–∞–ø—Ä. —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏, –Ω–∞—É—á–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏, –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∏ –∞–≥–µ–Ω—Ü–∏–∏),
  –ù–û:
  * –Ω–µ –∏–∑–º–∏—Å–ª—è–π –±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ—Å–∫–∏ –¥–∞–Ω–Ω–∏/DOI/—Å—Ç—Ä–∞–Ω–∏—Ü–∏;
  * –∞–∫–æ –Ω–µ —Å–∏ —Å–∏–≥—É—Ä–µ–Ω, –º–∞—Ä–∫–∏—Ä–∞–π –≥–æ –∫–∞—Ç–æ –Ω–µ—Å–∏–≥—É—Ä–Ω–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–∞–∫ –¥–∞ —Å–µ –ø—Ä–æ–≤–µ—Ä–∏ (–∫–∞–∫–≤–∏ –¥–∞–Ω–Ω–∏/–∏–∑—Ç–æ—á–Ω–∏–∫ —Å–∞ –Ω—É–∂–Ω–∏).
- –í –∫—Ä–∞—è –Ω–∞ –í–°–ï–ö–ò –æ—Ç–≥–æ–≤–æ—Ä –¥–æ–±–∞–≤—è–π –æ—Ç–¥–µ–ª–µ–Ω —Ä–µ–¥: ‚Äû–ù–∏–≤–æ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç: X/5‚Äú (X=1..5).
  5 = –æ–±—â–æ–ø—Ä–∏–µ—Ç–æ/–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–∏–≥—É—Ä–Ω–æ; 4 = –º–Ω–æ–≥–æ –≤–µ—Ä–æ—è—Ç–Ω–æ; 3 = –≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ –∑–∞–≤–∏—Å–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç/–¥–∞–Ω–Ω–∏;
  2 = —Å–ª–∞–±–∞ –æ–ø–æ—Ä–∞/–ª–∏–ø—Å–≤–∞—Ç –¥–∞–Ω–Ω–∏; 1 = —Å–ø–µ–∫—É–ª–∞—Ç–∏–≤–Ω–æ.

–û–ü–û–†–ù–ò –¢–ï–ú–ò –û–¢ –ö–£–†–°–ê (–∏–∑–ø–æ–ª–∑–≤–∞–π –≥–∏ –∫–∞—Ç–æ –±–∞–∑–æ–≤–∞ —Ä–∞–º–∫–∞ –ø—Ä–∏ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞):
1) –ê–¢–ú–û–°–§–ï–†–ê: –µ–º–∏—Å–∏–∏ NOx, –§–ü–ß, –ø–∞—Ä–Ω–∏–∫–æ–≤ –µ—Ñ–µ–∫—Ç.
2) –•–ò–î–†–û–°–§–ï–†–ê: –µ—É—Ç—Ä–æ—Ñ–∏–∫–∞—Ü–∏—è, —Å–≤–µ—Ç–ª–∏–Ω–µ–Ω —Ä–µ–∂–∏–º, pH.
3) –ü–û–ß–í–ò –ò –û–¢–ü–ê–î–™–¶–ò: –ø–ª–∞—Å—Ç–æ–≤–∞ –µ—Ä–æ–∑–∏—è, –Ω–∏—Ç—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è/–∫—Ä—ä–≥–æ–≤—Ä–∞—Ç –Ω–∞ –∞–∑–æ—Ç–∞, –º–∏–∫—Ä–æ–ø–ª–∞—Å—Ç–º–∞—Å–∏, –ø–µ—Å—Ç–∏—Ü–∏–¥–∏.

–°–¢–†–£–ö–¢–£–†–ê –ù–ê –ö–û–ù–°–£–õ–¢–ê–¶–ò–Ø–¢–ê (–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ):
1) –ï–∫–æ-–¥–∏–∞–≥–Ω–æ–∑–∞: —Å–ª–∞–± –µ–∫–æ–ª–æ–≥–∏—á–µ–Ω –ø—É–Ω–∫—Ç + –æ—Å–Ω–æ–≤–Ω–∏ —Ä–∏—Å–∫–æ–≤–µ (3‚Äì5 bullets).
2) –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∏ –º–µ—Ä–∫–∏ + –∑–µ–ª–µ–Ω–æ-–¥–∏–≥–∏—Ç–∞–ª–Ω–æ —Ä–µ—à–µ–Ω–∏–µ (Digital Twin / AI / IoT), —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ –∑–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç—Ç–∞ (3‚Äì6 bullets).
3) –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏: 3‚Äì6 –∏–∑–º–µ—Ä–∏–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (–∏–º–µ + –µ–¥–∏–Ω–∏—Ü–∞ + –∫–∞–∫–≤–∏ –¥–∞–Ω–Ω–∏ —Ç—Ä—è–±–≤–∞—Ç).
4) –î–æ–ø—É—Å–∫–∞–Ω–∏—è/–ª–∏–ø—Å–≤–∞—â–∏ –¥–∞–Ω–Ω–∏: –∫–∞–∫–≤–æ –ª–∏–ø—Å–≤–∞ –∏ –∫–∞–∫ –¥–∞ —Å–µ –ø—Ä–æ–≤–µ—Ä–∏.
"""

# -------------------------
# Output length control
# -------------------------
def get_gen_config(is_detailed: bool) -> genai.GenerationConfig:
    # Standard: max_output_tokens=1500
    # Detailed:  max_output_tokens=3000
    return genai.GenerationConfig(
        temperature=0.4,
        max_output_tokens=3000 if is_detailed else 1500,
    )

def user_requests_detail(text: str) -> bool:
    t = (text or "").lower()
    triggers = [
        "–ø–æ–¥—Ä–æ–±–Ω–æ", "–ø–æ-–ø–æ–¥—Ä–æ–±–Ω–æ", "–ø–æ–¥—Ä–æ–±–Ω–∞", "–ø–æ–¥—Ä–æ–±–µ–Ω",
        "—Ä–∞–∑—à–∏—Ä–∏", "—Ä–∞–∑—à–∏—Ä–µ–Ω–æ", "–ø–æ–≤–µ—á–µ –¥–µ—Ç–∞–π–ª–∏", "–¥–∞–π –ø–æ–≤–µ—á–µ",
        "–≤ –¥–µ—Ç–∞–π–ª–∏", "–¥–µ—Ç–∞–π–ª–Ω–æ", "–æ–±—è—Å–Ω–∏ –ø–æ–¥—Ä–æ–±–Ω–æ", "–ø–æ-–¥–µ—Ç–∞–π–ª–Ω–æ"
    ]
    return any(x in t for x in triggers)

# -------------------------
# UI
# -------------------------
st.title("üå± AI –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç –ø–æ –ï–∫–æ–ª–æ–≥–∏—è (EcoAI)")
st.markdown(
    "EcoAI –ø–æ–¥–ø–æ–º–∞–≥–∞ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞ —Ä–µ—à–µ–Ω–∏—è –≤ –¥—É—Ö–∞ –Ω–∞ **Green‚ÄìDigital Transition**."
)

with st.sidebar:
    st.header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    specialty = st.selectbox("–ò–∑–±–µ—Ä–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç:", SPECIALTIES, index=0)

    verbosity_mode = st.radio(
        "–†–µ–∂–∏–º –Ω–∞ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è:",
        ["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ (500‚Äì800 –¥—É–º–∏)", "–ü–æ–¥—Ä–æ–±–Ω–æ (–ø–æ –∑–∞—è–≤–∫–∞)"],
        index=0
    )

    st.info(
        "üí° –°—ä–≤–µ—Ç: –û–ø–∏—à–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å —Ü–µ–ª, –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è/–æ–±–æ—Ä—É–¥–≤–∞–Ω–µ, –º–∞—Ç–µ—Ä–∏–∞–ª–∏, –µ–Ω–µ—Ä–≥–∏—è, "
        "–æ—Ç–ø–∞–¥—ä—Ü–∏/–µ–º–∏—Å–∏–∏ –∏ –∫–∞–∫–≤–æ —Ç–æ—á–Ω–æ –∏—Å–∫–∞—à –¥–∞ –ø–æ–¥–æ–±—Ä–∏—à –≤ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç."
    )

    if st.button("üßπ –ù–æ–≤–∞ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è (–∏–∑—á–∏—Å—Ç–∏ —á–∞—Ç–∞)"):
        st.session_state.messages = []
        st.session_state.last_specialty = None
        st.rerun()

# -------------------------
# Session state
# -------------------------
if "messages" not in st.session_state:
    st.session_state.messages = []
if "last_specialty" not in st.session_state:
    st.session_state.last_specialty = None

def add_intro_message(current_specialty: str):
    intro = (
        f"–ó–¥—Ä–∞–≤–µ–π—Ç–µ! –ê–∑ —Å—ä–º **EcoAI** –∏ —â–µ –∫–æ–Ω—Å—É–ª—Ç–∏—Ä–∞–º **–ø—Ä–æ–µ–∫—Ç –ø–æ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç: {current_specialty}**.\n\n"
        "–ó–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ–º –±—ä—Ä–∑–æ, –Ω–∞–ø–∏—à–µ—Ç–µ:\n"
        "- **–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞**\n"
        "- **–ö—Ä–∞—Ç–∫–æ —Ä–µ–∑—é–º–µ** (1‚Äì5 –∏–∑—Ä–µ—á–µ–Ω–∏—è)\n"
        "- **–ö–æ–Ω—Ç–µ–∫—Å—Ç/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (–∫—ä–¥–µ –∏ –∫–∞–∫ —â–µ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞)\n"
        "- **–ö–ª—é—á–æ–≤–∏ –µ–ª–µ–º–µ–Ω—Ç–∏** (–æ–±–æ—Ä—É–¥–≤–∞–Ω–µ/–ø—Ä–æ—Ü–µ—Å/–º–∞—Ç–µ—Ä–∏–∞–ª–∏/–µ–Ω–µ—Ä–≥–∏—è/–¥–∞–Ω–Ω–∏)\n"
        "- **–û—á–∞–∫–≤–∞–Ω–∏ –æ—Ç–ø–∞–¥—ä—Ü–∏/–µ–º–∏—Å–∏–∏/—Ä–µ—Å—É—Ä—Å–∏** (–∞–∫–æ —Å–∞ –∏–∑–≤–µ—Å—Ç–Ω–∏)\n\n"
        "–©–µ –æ—Ç–≥–æ–≤–æ—Ä—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–æ (–µ–∫–æ-–¥–∏–∞–≥–Ω–æ–∑–∞ ‚Üí –º–µ—Ä–∫–∏ + –∑–µ–ª–µ–Ω–æ-–¥–∏–≥–∏—Ç–∞–ª–Ω–æ —Ä–µ—à–µ–Ω–∏–µ ‚Üí –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ ‚Üí –∫–∞–∫–≤–æ –¥–∞ —Å–µ –ø—Ä–æ–≤–µ—Ä–∏)."
    )
    st.session_state.messages.append({"role": "model", "parts": [intro]})

# Reset chat if empty or specialty changed
if not st.session_state.messages or st.session_state.last_specialty != specialty:
    st.session_state.messages = []
    add_intro_message(specialty)
    st.session_state.last_specialty = specialty

# Display chat history
for m in st.session_state.messages:
    role = "user" if m["role"] == "user" else "assistant"
    with st.chat_message(role):
        st.markdown(m["parts"][0])

# -------------------------
# Chat input
# -------------------------
if prompt := st.chat_input("–û–ø–∏—à–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–∏ —Ç—É–∫..."):
    # Hidden context: keep specialty conditioning for all subsequent answers
    full_prompt = f"[–°–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç: {specialty}] {prompt}"

    st.session_state.messages.append({"role": "user", "parts": [full_prompt]})
    with st.chat_message("user"):
        st.markdown(prompt)

    # Decide verbosity
    detailed_by_ui = (verbosity_mode == "–ü–æ–¥—Ä–æ–±–Ω–æ (–ø–æ –∑–∞—è–≤–∫–∞)")
    detailed_by_text = user_requests_detail(prompt)
    is_detailed = detailed_by_ui or detailed_by_text

    with st.chat_message("assistant"):
        with st.spinner("EcoAI –∞–Ω–∞–ª–∏–∑–∏—Ä–∞..."):
            try:
                # Gemini expects roles: 'user' and 'model'
                api_history = [{"role": mm["role"], "parts": mm["parts"]} for mm in st.session_state.messages]

                model = genai.GenerativeModel(
                    model_name="gemini-2.5-flash",
                    system_instruction=SYSTEM_PROMPT,
                    generation_config=get_gen_config(is_detailed),
                )

                response = model.generate_content(api_history)
                st.markdown(response.text)

                st.session_state.messages.append({"role": "model", "parts": [response.text]})
            except Exception as e:
                st.error(f"–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞: {str(e)}")
