import streamlit as st
import google.generativeai as genai

# -------------------------
# 1) –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
# -------------------------
st.set_page_config(page_title="AI –ï–∫–æ-–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç", page_icon="üå±", layout="wide")

# -------------------------
# 2) API –∫–ª—é—á
# -------------------------
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("–õ–∏–ø—Å–≤–∞ API –∫–ª—é—á. –ú–æ–ª—è, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≥–æ –≤ Streamlit Secrets.")
    st.stop()

# -------------------------
# 3) –°–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç–∏ (–ø—ä–ª–µ–Ω —Å–ø–∏—Å—ä–∫)
# -------------------------
SPECIALTIES = [
    "–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –∏ –∫–æ–º–ø—é—Ç—ä—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏",
    "–ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞ –∏ –∑–µ–º–µ–¥–µ–ª—Å–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∞",
    "–ö–æ–º–ø—é—Ç—ä—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –∏ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏–∏",
    "–ï–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞",
    "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –Ω–∞ —Ö—Ä–∞–Ω–∏—Ç–µ",
    "–¢–æ–ø–ª–æ- –∏ –≥–∞–∑–æ—Å–Ω–∞–±–¥—è–≤–∞–Ω–µ",
    "–ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª–Ω–æ –∏–Ω–∂–µ–Ω–µ—Ä—Å—Ç–≤–æ",
    "–î–∏–∑–∞–π–Ω, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∏ –º–µ–Ω–∏–¥–∂–º—ä–Ω—Ç –Ω–∞ –º–æ–¥–Ω–∞—Ç–∞ –∏–Ω–¥—É—Å—Ç—Ä–∏—è",
]

# -------------------------
# 4) –ö–æ–Ω—Ç—Ä–æ–ª –Ω–∞ –æ–±–µ–º–∞
# -------------------------
DETAIL_TRIGGERS = [
    "–ø–æ–¥—Ä–æ–±–Ω–æ", "–ø–æ-–ø–æ–¥—Ä–æ–±–Ω–æ", "–ø–æ–¥—Ä–æ–±–Ω–∞ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è", "—Ä–∞–∑—à–∏—Ä–∏", "—Ä–∞–∑—à–∏—Ä–µ–Ω–æ",
    "–≤ –¥–µ—Ç–∞–π–ª–∏", "–¥–µ—Ç–∞–π–ª–Ω–æ", "–¥–∞–π –ø–æ–≤–µ—á–µ –¥–µ—Ç–∞–π–ª–∏", "–ø–æ–≤–µ—á–µ –¥–µ—Ç–∞–π–ª–∏", "–æ–±—è—Å–Ω–∏ –ø–æ–¥—Ä–æ–±–Ω–æ"
]

def user_requests_detail(text: str) -> bool:
    t = (text or "").lower()
    return any(x in t for x in DETAIL_TRIGGERS)

def get_generation_config(is_detailed: bool) -> genai.GenerationConfig:
    return genai.GenerationConfig(
        temperature=0.4,
        max_output_tokens=3000 if is_detailed else 1500,  # –ø–æ —Ç–≤–æ–µ –∏–∑–∏—Å–∫–≤–∞–Ω–µ
    )

# -------------------------
# 5) System Prompt (–∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω –ø–æ –∏–∑–∏—Å–∫–≤–∞–Ω–∏—è—Ç–∞)
# -------------------------
SYSTEM_PROMPT = """
–¢–∏ —Å–∏ EcoAI ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª/–∫–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç –ø–æ –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∞ –ï–∫–æ–ª–æ–≥–∏—è –≤—ä–≤ –§–∞–∫—É–ª—Ç–µ—Ç ‚Äû–¢–µ—Ö–Ω–∏–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏‚Äú ‚Äì –Ø–º–±–æ–ª.
–¶–µ–ª—Ç–∞ —Ç–∏ –µ –¥–∞ –∫–æ–Ω—Å—É–ª—Ç–∏—Ä–∞—à —Å—Ç—É–¥–µ–Ω—Ç –∫–∞–∫ –¥–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∏ –∞—Å–ø–µ–∫—Ç–∏ –∏ ‚ÄûGreen‚ÄìDigital Transition‚Äú –≤ –∏–Ω–∂–µ–Ω–µ—Ä–µ–Ω –ø—Ä–æ–µ–∫—Ç.

–ö–†–ò–¢–ò–ß–ù–ò –ü–†–ê–í–ò–õ–ê:
1) –°–™–û–ë–†–ê–ó–Ø–í–ê–ô –°–ü–ï–¶–ò–ê–õ–ù–û–°–¢–¢–ê:
   - –°–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç—Ç–∞ –µ –ø–æ–¥–∞–¥–µ–Ω–∞ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ –≤—Å—è–∫–æ —Å—Ç—É–¥–µ–Ω—Ç—Å–∫–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –∫–∞—Ç–æ —Ç–∞–≥: [–°–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç: ...]
   - –í—Å–∏—á–∫–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ —Å—ä–æ–±—Ä–∞–∑–µ–Ω–∏ —Å —Ç–æ–∑–∏ –¥–æ–º–µ–π–Ω (—Ç–∏–ø–∏—á–Ω–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ø—Ä–æ—Ü–µ—Å–∏, —Ä–∏—Å–∫–æ–≤–µ, –º–µ—Ä–∫–∏, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏).

2) –ò–ó–¢–û–ß–ù–ò–¶–ò:
   - –ë–∞–∑–∏—Ä–∞–π —Å–µ –Ω–∞ –ª–µ–∫—Ü–∏–∏—Ç–µ –ø–æ –ï–∫–æ–ª–æ–≥–∏—è (–¥–æ–ª—É) –∫–∞—Ç–æ —Ä–∞–º–∫–∞, –Ω–æ –∏–º–∞—à –ø—Ä–∞–≤–æ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—à –∏ –≤—ä–Ω—à–Ω–∏ –Ω–∞–¥–µ–∂–¥–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏/–¥–æ–±—Ä–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏/—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏,
     –∫–æ–≥–∞—Ç–æ –ª–µ–∫—Ü–∏–∏—Ç–µ –Ω–µ —Å—Ç–∏–≥–∞—Ç –∑–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–µ–Ω –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ-–µ–∫–æ–ª–æ–≥–∏—á–µ–Ω —Å—ä–≤–µ—Ç.
   - –ù–ï –∏–∑–º–∏—Å–ª—è–π DOI, —Å—Ç—Ä–∞–Ω–∏—Ü–∏, —Ç–æ—á–Ω–∏ –±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ—Å–∫–∏ –∑–∞–ø–∏—Å–∏. –ê–∫–æ —Å–µ –Ω–∞–ª–∞–≥–∞, –ø–æ—Å–æ—á–∏ –∏–∑—Ç–æ—á–Ω–∏–∫–∞ —Å–∞–º–æ –æ–±—â–æ (–Ω–∞–ø—Ä. ISO/IEC, IPCC, EEA, WHO,
     –Ω–∞—Ü–∏–æ–Ω–∞–ª–Ω–∏/–µ–≤—Ä–æ–ø–µ–π—Å–∫–∏ –¥–∏—Ä–µ–∫—Ç–∏–≤–∏, —Ä—ä–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏, peer-reviewed –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞) –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç—ä—Ç –¥–∞ –ø—Ä–æ–≤–µ—Ä–∏.

3) –û–ë–ï–ú:
   - –ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ: 500‚Äì800 –¥—É–º–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–æ —Å bullets (–∫—Ä–∞—Ç–∫–∏ —Ç–æ—á–∫–∏, –±–µ–∑ –¥—ä–ª–≥–∏ –∞–±–∑–∞—Ü–∏).
   - –°–∞–º–æ –∞–∫–æ —Å—Ç—É–¥–µ–Ω—Ç—ä—Ç –∏–∑—Ä–∏—á–Ω–æ –ø–æ–∏—Å–∫–∞ ‚Äû–ø–æ-–ø–æ–¥—Ä–æ–±–Ω–æ‚Äú –∏–ª–∏ –µ –∏–∑–±—Ä–∞–Ω —Ä–µ–∂–∏–º ‚Äû–ü–æ–¥—Ä–æ–±–Ω–æ‚Äú, –º–æ–∂–µ—à –¥–∞ –¥–∞–¥–µ—à –ø–æ-–¥—ä–ª—ä–≥ –æ—Ç–≥–æ–≤–æ—Ä.

4) –°–¢–†–£–ö–¢–£–†–ê (–ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ):
   A) –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è (1‚Äì3 bullets, –∞–∫–æ –ª–∏–ø—Å–≤–∞—Ç –¥–∞–Ω–Ω–∏)
   B) –ï–∫–æ-–¥–∏–∞–≥–Ω–æ–∑–∞: —Å–ª–∞–± –µ–∫–æ–ª–æ–≥–∏—á–µ–Ω –ø—É–Ω–∫—Ç + —Ä–∏—Å–∫–æ–≤–µ (3‚Äì5 bullets)
   C) –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∏ –º–µ—Ä–∫–∏ + –∑–µ–ª–µ–Ω–æ-–¥–∏–≥–∏—Ç–∞–ª–Ω–æ —Ä–µ—à–µ–Ω–∏–µ (Digital Twin / AI / IoT), —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ –∑–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç—Ç–∞ (3‚Äì6 bullets)
   D) –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏: 3‚Äì6 –∏–∑–º–µ—Ä–∏–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (–∏–º–µ + –µ–¥–∏–Ω–∏—Ü–∞ + –Ω—É–∂–Ω–∏ –¥–∞–Ω–Ω–∏)
   E) –ö–∞–∫–≤–æ –¥–∞ —Å–µ –ø—Ä–æ–≤–µ—Ä–∏ / –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (2‚Äì5 bullets)
   F) –ù–∏–≤–æ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç: X/5 (–æ—Ç–¥–µ–ª–µ–Ω —Ä–µ–¥, –ø–æ—Å–ª–µ–¥–µ–Ω)

5) –ù–ò–í–û –ù–ê –°–ò–ì–£–†–ù–û–°–¢ (–≤–∏–Ω–∞–≥–∏ –Ω–∞–∫—Ä–∞—è):
   - 5/5: –æ–±—â–æ–ø—Ä–∏–µ—Ç–æ/–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–∏–≥—É—Ä–Ω–æ
   - 4/5: –º–Ω–æ–≥–æ –≤–µ—Ä–æ—è—Ç–Ω–æ (—Ç–∏–ø–∏—á–Ω–∞ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞)
   - 3/5: –≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–æ —Å–∏–ª–Ω–æ –∑–∞–≤–∏—Å–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç/–¥–∞–Ω–Ω–∏
   - 2/5: —Å–ª–∞–±–∞ –æ–ø–æ—Ä–∞/–ª–∏–ø—Å–≤–∞—Ç –≤–∞–∂–Ω–∏ –¥–∞–Ω–Ω–∏
   - 1/5: —Å–ø–µ–∫—É–ª–∞—Ç–∏–≤–Ω–æ

–û–ü–û–†–ù–ò –¢–ï–ú–ò –û–¢ –ö–£–†–°–ê (–∏–∑–ø–æ–ª–∑–≤–∞–π –∫–∞—Ç–æ –±–∞–∑–æ–≤–∞ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∞ —Ä–∞–º–∫–∞):
1) –ê–¢–ú–û–°–§–ï–†–ê: –µ–º–∏—Å–∏–∏ NOx, –§–ü–ß, –ø–∞—Ä–Ω–∏–∫–æ–≤ –µ—Ñ–µ–∫—Ç.
2) –•–ò–î–†–û–°–§–ï–†–ê: –µ—É—Ç—Ä–æ—Ñ–∏–∫–∞—Ü–∏—è, –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ —Å–≤–µ—Ç–ª–∏–Ω–Ω–∏—è —Ä–µ–∂–∏–º, pH –Ω–∞ –≤–æ–¥–∏—Ç–µ.
3) –ü–û–ß–í–ò –ò –û–¢–ü–ê–î–™–¶–ò: –ø–ª–∞—Å—Ç–æ–≤–∞ –µ—Ä–æ–∑–∏—è, –Ω–∏—Ç—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è/–∫—Ä—ä–≥–æ–≤—Ä–∞—Ç –Ω–∞ –∞–∑–æ—Ç–∞, –º–∏–∫—Ä–æ–ø–ª–∞—Å—Ç–º–∞—Å–∏, –ø–µ—Å—Ç–∏—Ü–∏–¥–∏.
"""

# -------------------------
# 6) UI
# -------------------------
st.title("üå± AI –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç –ø–æ –ï–∫–æ–ª–æ–≥–∏—è (EcoAI)")
st.markdown(
    "**–î–æ–±—Ä–µ –¥–æ—à–ª–∏!** EcoAI –ø–æ–¥–ø–æ–º–∞–≥–∞ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞ —Ä–µ—à–µ–Ω–∏—è –≤ –¥—É—Ö–∞ –Ω–∞ *Green‚ÄìDigital Transition*."
)

with st.sidebar:
    st.header("–¢–≤–æ—è—Ç –ø—Ä–æ—Ñ–∏–ª")
    specialty = st.selectbox("–ò–∑–±–µ—Ä–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç:", SPECIALTIES, index=0)

    verbosity_mode = st.radio(
        "–†–µ–∂–∏–º –Ω–∞ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è:",
        ["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ (500‚Äì800 –¥—É–º–∏)", "–ü–æ–¥—Ä–æ–±–Ω–æ (–ø–æ –∑–∞—è–≤–∫–∞)"],
        index=0
    )

    st.info("üí° –°—ä–≤–µ—Ç: –î–∞–π —Ü–µ–ª, –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è/–æ–±–æ—Ä—É–¥–≤–∞–Ω–µ, –º–∞—Ç–µ—Ä–∏–∞–ª–∏, –µ–Ω–µ—Ä–≥–∏—è, –æ—Ç–ø–∞–¥—ä—Ü–∏/–µ–º–∏—Å–∏–∏ –∏ –∫–∞–∫–≤–æ –∏—Å–∫–∞—à –¥–∞ –ø–æ–¥–æ–±—Ä–∏—à.")

    if st.button("üßπ –ù–æ–≤–∞ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è (–∏–∑—á–∏—Å—Ç–∏ —á–∞—Ç–∞)"):
        st.session_state.messages = []
        st.session_state.last_specialty = None
        st.rerun()

# -------------------------
# 7) –ß–∞—Ç —Å–µ—Å–∏—è
# -------------------------
if "messages" not in st.session_state:
    st.session_state.messages = []
if "last_specialty" not in st.session_state:
    st.session_state.last_specialty = None

def ensure_intro_for_specialty(current_specialty: str):
    """
    –í–∞–∂–Ω–æ: –¥–æ–±–∞–≤—è–º–µ intro –∫–∞—Ç–æ model —Å—ä–æ–±—â–µ–Ω–∏–µ (–∫–∞–∫—Ç–æ –≤ —Ä–∞–±–æ—Ç–µ—â–∏—è –∫–æ–¥),
    –∑–∞ –¥–∞ –∏–º–∞ –ø—Ä–∏—è—Ç–µ–Ω —Å—Ç–∞—Ä—Ç, –∏ –∑–∞ –¥–∞ –µ —è—Å–Ω–æ, —á–µ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è—Ç–∞ –µ –ø–æ –∏–∑–±—Ä–∞–Ω–∞—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç.
    """
    intro_msg = (
        f"–ó–¥—Ä–∞–≤–µ–π—Ç–µ! –ê–∑ —Å—ä–º **EcoAI** –∏ —â–µ –∫–æ–Ω—Å—É–ª—Ç–∏—Ä–∞–º **–ø—Ä–æ–µ–∫—Ç –ø–æ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç: {current_specialty}**.\n\n"
        "–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ:\n"
        "- **–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞**\n"
        "- **–ö—Ä–∞—Ç–∫–æ —Ä–µ–∑—é–º–µ** (1‚Äì5 –∏–∑—Ä–µ—á–µ–Ω–∏—è)\n"
        "- **–ö–æ–Ω—Ç–µ–∫—Å—Ç/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**\n"
        "- **–ö–ª—é—á–æ–≤–∏ –µ–ª–µ–º–µ–Ω—Ç–∏** (–æ–±–æ—Ä—É–¥–≤–∞–Ω–µ/–ø—Ä–æ—Ü–µ—Å/–º–∞—Ç–µ—Ä–∏–∞–ª–∏/–µ–Ω–µ—Ä–≥–∏—è/–¥–∞–Ω–Ω–∏)\n"
        "- **–û—á–∞–∫–≤–∞–Ω–∏ –µ–º–∏—Å–∏–∏/–æ—Ç–ø–∞–¥—ä—Ü–∏/—Ä–µ—Å—É—Ä—Å–∏** (–∞–∫–æ —Å–∞ –∏–∑–≤–µ—Å—Ç–Ω–∏)\n"
    )
    st.session_state.messages.append({"role": "model", "parts": [intro_msg]})

# –ê–∫–æ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç—Ç–∞ —Å–µ —Å–º–µ–Ω–∏ ‚Äì —Ä–µ—Å—Ç–∞—Ä—Ç (–∏–Ω–∞—á–µ —â–µ —Å–µ –º–µ—à–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç)
if st.session_state.last_specialty != specialty:
    st.session_state.messages = []
    ensure_intro_for_specialty(specialty)
    st.session_state.last_specialty = specialty

# –ê–∫–æ –µ –ø—Ä–∞–∑–Ω–æ (–ø—ä—Ä–≤–æ –æ—Ç–≤–∞—Ä—è–Ω–µ)
if not st.session_state.messages:
    ensure_intro_for_specialty(specialty)
    st.session_state.last_specialty = specialty

# –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞
for msg in st.session_state.messages:
    role = "user" if msg["role"] == "user" else "assistant"
    with st.chat_message(role):
        st.markdown(msg["parts"][0])

# -------------------------
# 8) –§—É–Ω–∫—Ü–∏—è –∑–∞ Gemini –æ—Ç–≥–æ–≤–æ—Ä (–ø–æ–ª–∑–≤–∞ chat —Ä–µ–∂–∏–º, –∫–∞–∫—Ç–æ —Ä–∞–±–æ—Ç–µ—â–∏—è –∫–æ–¥)
#    + –≤–∞–∂–Ω–∞ –∫–æ—Ä–µ–∫—Ü–∏—è: –ù–ï –¥—É–±–ª–∏—Ä–∞–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—è user prompt –≤ history
# -------------------------
def get_gemini_response(messages, is_detailed: bool) -> str:
    model = genai.GenerativeModel(
        model_name="gemini-2.5-flash",
        system_instruction=SYSTEM_PROMPT,
        generation_config=get_generation_config(is_detailed),
    )

    # –í–∞–∂–Ω–æ: —Å—Ç–∞—Ä—Ç –Ω–∞ —á–∞—Ç —Å –∏—Å—Ç–æ—Ä–∏—è –ë–ï–ó –ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ user —Å—ä–æ–±—â–µ–Ω–∏–µ, –ø–æ—Å–ª–µ send_message(–ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ).
    history = messages[:-1] if len(messages) > 1 else []
    chat = model.start_chat(history=history)

    last = messages[-1]
    user_text = last["parts"][0] if last and last.get("parts") else ""
    response = chat.send_message(user_text)

    # response.text –ø–æ–Ω—è–∫–æ–≥–∞ –º–æ–∂–µ –¥–∞ –µ None; –∑–∞—Ç–æ–≤–∞ fallback:
    text = getattr(response, "text", None)
    if text:
        return text

    # fallback –∫—ä–º candidates/parts
    try:
        if response.candidates:
            parts = response.candidates[0].content.parts
            out = []
            for p in parts:
                if hasattr(p, "text") and p.text:
                    out.append(p.text)
            joined = "\n".join(out).strip()
            if joined:
                return joined
    except Exception:
        pass

    return "–ò–∑–≤–∏–Ω–µ—Ç–µ ‚Äî –Ω–µ —É—Å–ø—è—Ö –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–º –æ—Ç–≥–æ–≤–æ—Ä. –û–ø–∏—Ç–∞–π—Ç–µ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ –ø–æ–≤–µ—á–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –¥–µ—Ç–∞–π–ª–∏.\n\n–ù–∏–≤–æ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç: 2/5"

# -------------------------
# 9) –í—Ö–æ–¥ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
# -------------------------
if prompt := st.chat_input("–û–ø–∏—à–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–∏ —Ç—É–∫..."):
    # –°–∫—Ä–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç (–∏–∑–∏—Å–∫–≤–∞–Ω–µ #2)
    full_prompt = f"[–°–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç: {specialty}] {prompt}"

    st.session_state.messages.append({"role": "user", "parts": [full_prompt]})
    with st.chat_message("user"):
        st.markdown(prompt)

    detailed_by_ui = (verbosity_mode == "–ü–æ–¥—Ä–æ–±–Ω–æ (–ø–æ –∑–∞—è–≤–∫–∞)")
    detailed_by_text = user_requests_detail(prompt)
    is_detailed = detailed_by_ui or detailed_by_text

    with st.chat_message("assistant"):
        with st.spinner("EcoAI –∞–Ω–∞–ª–∏–∑–∏—Ä–∞..."):
            try:
                answer = get_gemini_response(st.session_state.messages, is_detailed=is_detailed)
                st.markdown(answer)
                st.session_state.messages.append({"role": "model", "parts": [answer]})
            except Exception as e:
                st.error(f"–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞: {str(e)}")
