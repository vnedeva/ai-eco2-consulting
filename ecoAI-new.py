import streamlit as st
import google.generativeai as genai

# -------------------------
# Page setup
# -------------------------
st.set_page_config(page_title="AI –ï–∫–æ-–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç", page_icon="üå±", layout="wide")

# -------------------------
# API key
# -------------------------
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("–õ–∏–ø—Å–≤–∞ API –∫–ª—é—á. –ú–æ–ª—è, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≥–æ –≤ Streamlit Secrets.")
    st.stop()

# -------------------------
# Specialties
# -------------------------
SPECIALTIES = [
    "–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –∏ –∫–æ–º–ø—é—Ç—ä—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏",
    "–ê–≤—Ç–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞ –∏ –∑–µ–º–µ–¥–µ–ª—Å–∫–∞ —Ç–µ—Ö–Ω–∏–∫–∞",
    "–ö–æ–º–ø—é—Ç—ä—Ä–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –∏ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏–∏",
    "–ï–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞",
    "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –Ω–∞ —Ö—Ä–∞–Ω–∏—Ç–µ",
    "–¢–æ–ø–ª–æ- –∏ –≥–∞–∑–æ—Å–Ω–∞–±–¥—è–≤–∞–Ω–µ",
    "–ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª–Ω–æ –∏–Ω–∂–µ–Ω–µ—Ä—Å—Ç–≤–æ",
    "–î–∏–∑–∞–π–Ω, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∏ –º–µ–Ω–∏–¥–∂–º—ä–Ω—Ç –Ω–∞ –º–æ–¥–Ω–∞—Ç–∞ –∏–Ω–¥—É—Å—Ç—Ä–∏—è",
]

# -------------------------
# System prompt
# -------------------------
SYSTEM_PROMPT = """
–¢–∏ —Å–∏ EcoAI ‚Äî –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª/–∫–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç –ø–æ –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∞ –ï–∫–æ–ª–æ–≥–∏—è –≤—ä–≤ –§–∞–∫—É–ª—Ç–µ—Ç ‚Äû–¢–µ—Ö–Ω–∏–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏‚Äú ‚Äì –Ø–º–±–æ–ª.
–¶–µ–ª—Ç–∞ —Ç–∏ –µ –¥–∞ –∫–æ–Ω—Å—É–ª—Ç–∏—Ä–∞—à —Å—Ç—É–¥–µ–Ω—Ç –∫–∞–∫ –¥–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∏ –∞—Å–ø–µ–∫—Ç–∏ –∏ ‚ÄûGreen‚ÄìDigital Transition‚Äú –≤ –∏–Ω–∂–µ–Ω–µ—Ä–µ–Ω –ø—Ä–æ–µ–∫—Ç.

–ö–†–ò–¢–ò–ß–ù–ò –ü–†–ê–í–ò–õ–ê:
- –í–∏–Ω–∞–≥–∏ —Å–µ —Å—ä–æ–±—Ä–∞–∑—è–≤–∞–π —Å—ä—Å —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç—Ç–∞, –∫–æ—è—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç—ä—Ç –µ –∏–∑–±—Ä–∞–ª. –û—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ —Ç–∏ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏ –∑–∞ —Ç–æ–∑–∏ –¥–æ–º–µ–π–Ω.
- –û—Ç–≥–æ–≤–∞—Ä—è–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–æ —Å –∫—Ä–∞—Ç–∫–∏ bullets (–∏–∑–±—è–≥–≤–∞–π –¥—ä–ª–≥–∏ –∞–±–∑–∞—Ü–∏; –∏–∑–ø–æ–ª–∑–≤–∞–π –ø–æ–¥—Ç–æ—á–∫–∏ –ø—Ä–∏ –Ω—É–∂–¥–∞).
- –ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ: 500‚Äì800 –¥—É–º–∏. –†–∞–∑—à–∏—Ä—è–≤–∞–π —Å–∞–º–æ –ø—Ä–∏ –∏–∑—Ä–∏—á–Ω–æ –∏—Å–∫–∞–Ω–µ –∑–∞ ‚Äû–ø–æ-–ø–æ–¥—Ä–æ–±–Ω–æ‚Äú –∏–ª–∏ –ø—Ä–∏ –∏–∑–±—Ä–∞–Ω —Ä–µ–∂–∏–º ‚Äû–ü–æ–¥—Ä–æ–±–Ω–æ‚Äú.
- –ú–æ–∂–µ—à –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—à –∏ –≤—ä–Ω—à–Ω–∏ –Ω–∞–¥–µ–∂–¥–Ω–∏ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏/–¥–æ–±—Ä–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏/—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏, –Ω–æ:
  * –ù–ï –∏–∑–º–∏—Å–ª—è–π –±–∏–±–ª–∏–æ–≥—Ä–∞—Ñ—Å–∫–∏ –¥–∞–Ω–Ω–∏/DOI/—Å—Ç—Ä–∞–Ω–∏—Ü–∏;
  * –∞–∫–æ –Ω–µ —Å–∏ —Å–∏–≥—É—Ä–µ–Ω, –º–∞—Ä–∫–∏—Ä–∞–π –≥–æ –∫–∞—Ç–æ –Ω–µ—Å–∏–≥—É—Ä–Ω–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–∞–∫ –¥–∞ —Å–µ –ø—Ä–æ–≤–µ—Ä–∏ (–∫–∞–∫–≤–∏ –¥–∞–Ω–Ω–∏/–∏–∑—Ç–æ—á–Ω–∏–∫ —Å–∞ –Ω—É–∂–Ω–∏).
- –í –∫—Ä–∞—è –Ω–∞ –í–°–ï–ö–ò –æ—Ç–≥–æ–≤–æ—Ä –¥–æ–±–∞–≤–∏ –æ—Ç–¥–µ–ª–µ–Ω —Ä–µ–¥: ‚Äû–ù–∏–≤–æ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç: X/5‚Äú (X=1..5).

–û–ü–û–†–ù–ò –¢–ï–ú–ò –û–¢ –ö–£–†–°–ê (—Ä–∞–º–∫–∞ –∑–∞ –µ–∫–æ-–¥–∏–∞–≥–Ω–æ–∑–∞):
1) –ê–¢–ú–û–°–§–ï–†–ê: NOx, –§–ü–ß, –ø–∞—Ä–Ω–∏–∫–æ–≤ –µ—Ñ–µ–∫—Ç.
2) –•–ò–î–†–û–°–§–ï–†–ê: –µ—É—Ç—Ä–æ—Ñ–∏–∫–∞—Ü–∏—è, —Å–≤–µ—Ç–ª–∏–Ω–µ–Ω —Ä–µ–∂–∏–º, pH.
3) –ü–û–ß–í–ò –ò –û–¢–ü–ê–î–™–¶–ò: –µ—Ä–æ–∑–∏—è, –Ω–∏—Ç—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è/–∞–∑–æ—Ç, –º–∏–∫—Ä–æ–ø–ª–∞—Å—Ç–º–∞—Å–∏, –ø–µ—Å—Ç–∏—Ü–∏–¥–∏.

–°–¢–†–£–ö–¢–£–†–ê –ù–ê –û–¢–ì–û–í–û–†–ê:
1) –ï–∫–æ-–¥–∏–∞–≥–Ω–æ–∑–∞ (3‚Äì5 bullets)
2) –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∏ –º–µ—Ä–∫–∏ + –∑–µ–ª–µ–Ω–æ-–¥–∏–≥–∏—Ç–∞–ª–Ω–æ —Ä–µ—à–µ–Ω–∏–µ (Digital Twin / AI / IoT) (3‚Äì6 bullets)
3) –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ (3‚Äì6: –∏–º–µ + –µ–¥–∏–Ω–∏—Ü–∞ + –Ω—É–∂–Ω–∏ –¥–∞–Ω–Ω–∏)
4) –î–æ–ø—É—Å–∫–∞–Ω–∏—è/–ª–∏–ø—Å–≤–∞—â–∏ –¥–∞–Ω–Ω–∏ (–∫–∞–∫–≤–æ –¥–∞ —Å–µ –ø—Ä–æ–≤–µ—Ä–∏)
"""

# -------------------------
# Output length control
# -------------------------
def get_gen_config(is_detailed: bool) -> genai.GenerationConfig:
    return genai.GenerationConfig(
        temperature=0.4,
        max_output_tokens=3000 if is_detailed else 1500,
    )

def user_requests_detail(text: str) -> bool:
    t = (text or "").lower()
    triggers = [
        "–ø–æ–¥—Ä–æ–±–Ω–æ", "–ø–æ-–ø–æ–¥—Ä–æ–±–Ω–æ", "–ø–æ–¥—Ä–æ–±–Ω–∞", "–ø–æ–¥—Ä–æ–±–µ–Ω",
        "—Ä–∞–∑—à–∏—Ä–∏", "—Ä–∞–∑—à–∏—Ä–µ–Ω–æ", "–ø–æ–≤–µ—á–µ –¥–µ—Ç–∞–π–ª–∏", "–¥–∞–π –ø–æ–≤–µ—á–µ",
        "–≤ –¥–µ—Ç–∞–π–ª–∏", "–¥–µ—Ç–∞–π–ª–Ω–æ", "–æ–±—è—Å–Ω–∏ –ø–æ–¥—Ä–æ–±–Ω–æ", "–ø–æ-–¥–µ—Ç–∞–π–ª–Ω–æ"
    ]
    return any(x in t for x in triggers)

def extract_text(response) -> str:
    """
    –ù–∞–¥–µ–∂–¥–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç –æ—Ç Gemini response (fallback –∫—ä–º candidates/parts).
    """
    # 1) –ù–∞–π-—á–µ—Å—Ç–æ —Ä–∞–±–æ—Ç–∏:
    txt = getattr(response, "text", None)
    if txt:
        return txt.strip()

    # 2) Fallback: candidates -> content -> parts
    try:
        if response.candidates:
            parts = response.candidates[0].content.parts
            out = []
            for p in parts:
                if hasattr(p, "text") and p.text:
                    out.append(p.text)
            joined = "\n".join(out).strip()
            if joined:
                return joined
    except Exception:
        pass

    return ""  # –∞–∫–æ –Ω—è–º–∞

# -------------------------
# UI
# -------------------------
st.title("üå± AI –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç –ø–æ –ï–∫–æ–ª–æ–≥–∏—è (EcoAI)")
st.markdown("EcoAI –ø–æ–¥–ø–æ–º–∞–≥–∞ –µ–∫–æ–ª–æ–≥–∏—á–Ω–∞—Ç–∞ —á–∞—Å—Ç –Ω–∞ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞ —Ä–µ—à–µ–Ω–∏—è –≤ –¥—É—Ö–∞ –Ω–∞ **Green‚ÄìDigital Transition**.")

with st.sidebar:
    st.header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    specialty = st.selectbox("–ò–∑–±–µ—Ä–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç:", SPECIALTIES, index=0)
    verbosity_mode = st.radio(
        "–†–µ–∂–∏–º –Ω–∞ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è:",
        ["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ (500‚Äì800 –¥—É–º–∏)", "–ü–æ–¥—Ä–æ–±–Ω–æ (–ø–æ –∑–∞—è–≤–∫–∞)"],
        index=0
    )

    st.info("üí° –°—ä–≤–µ—Ç: –û–ø–∏—à–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å —Ü–µ–ª, –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è/–æ–±–æ—Ä—É–¥–≤–∞–Ω–µ, –º–∞—Ç–µ—Ä–∏–∞–ª–∏, –µ–Ω–µ—Ä–≥–∏—è, –æ—Ç–ø–∞–¥—ä—Ü–∏/–µ–º–∏—Å–∏–∏ –∏ –∫–∞–∫–≤–æ –∏—Å–∫–∞—à –¥–∞ –ø–æ–¥–æ–±—Ä–∏—à.")

    if st.button("üßπ –ù–æ–≤–∞ –∫–æ–Ω—Å—É–ª—Ç–∞—Ü–∏—è (–∏–∑—á–∏—Å—Ç–∏ —á–∞—Ç–∞)"):
        st.session_state.chat_ui = []
        st.session_state.chat_model = []
        st.session_state.last_specialty = None
        st.rerun()

# -------------------------
# Session state
#   chat_ui: –∫–∞–∫–≤–æ –ø–æ–∫–∞–∑–≤–∞–º–µ
#   chat_model: –∫–∞–∫–≤–æ –ø—Ä–∞—â–∞–º–µ –Ω–∞ –º–æ–¥–µ–ª–∞
# -------------------------
if "chat_ui" not in st.session_state:
    st.session_state.chat_ui = []
if "chat_model" not in st.session_state:
    st.session_state.chat_model = []
if "last_specialty" not in st.session_state:
    st.session_state.last_specialty = None

def reset_with_intro(current_specialty: str):
    st.session_state.chat_ui = []
    st.session_state.chat_model = []

    intro = (
        f"–ó–¥—Ä–∞–≤–µ–π—Ç–µ! –ê–∑ —Å—ä–º **EcoAI** –∏ —â–µ –∫–æ–Ω—Å—É–ª—Ç–∏—Ä–∞–º **–ø—Ä–æ–µ–∫—Ç –ø–æ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç: {current_specialty}**.\n\n"
        "–ú–æ–ª—è, –Ω–∞–ø–∏—à–µ—Ç–µ:\n"
        "- **–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞**\n"
        "- **–ö—Ä–∞—Ç–∫–æ —Ä–µ–∑—é–º–µ** (1‚Äì5 –∏–∑—Ä–µ—á–µ–Ω–∏—è)\n"
        "- **–ö–æ–Ω—Ç–µ–∫—Å—Ç/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**\n"
        "- **–ö–ª—é—á–æ–≤–∏ –µ–ª–µ–º–µ–Ω—Ç–∏** (–æ–±–æ—Ä—É–¥–≤–∞–Ω–µ/–ø—Ä–æ—Ü–µ—Å/–º–∞—Ç–µ—Ä–∏–∞–ª–∏/–µ–Ω–µ—Ä–≥–∏—è/–¥–∞–Ω–Ω–∏)\n"
        "- **–û—á–∞–∫–≤–∞–Ω–∏ –æ—Ç–ø–∞–¥—ä—Ü–∏/–µ–º–∏—Å–∏–∏/—Ä–µ—Å—É—Ä—Å–∏** (–∞–∫–æ —Å–∞ –∏–∑–≤–µ—Å—Ç–Ω–∏)\n\n"
        "–©–µ –æ—Ç–≥–æ–≤–æ—Ä—è: –µ–∫–æ-–¥–∏–∞–≥–Ω–æ–∑–∞ ‚Üí –º–µ—Ä–∫–∏ + –∑–µ–ª–µ–Ω–æ-–¥–∏–≥–∏—Ç–∞–ª–Ω–æ —Ä–µ—à–µ–Ω–∏–µ ‚Üí –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ ‚Üí –∫–∞–∫–≤–æ –¥–∞ —Å–µ –ø—Ä–æ–≤–µ—Ä–∏."
    )

    # –ü–æ–∫–∞–∑–≤–∞–º–µ intro –≤ UI, –Ω–æ –ù–ï –≥–æ –ø—Ä–∞—â–∞–º–µ –∫–∞—Ç–æ –ø—ä—Ä–≤–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –∫—ä–º –º–æ–¥–µ–ª–∞ (–≤–∞–∂–Ω–æ!)
    st.session_state.chat_ui.append({"role": "assistant", "text": intro})

# Reset if specialty changed or first load
if st.session_state.last_specialty != specialty or not st.session_state.chat_ui:
    reset_with_intro(specialty)
    st.session_state.last_specialty = specialty

# Render UI chat
for m in st.session_state.chat_ui:
    with st.chat_message(m["role"]):
        st.markdown(m["text"])

# -------------------------
# Chat input
# -------------------------
if prompt := st.chat_input("–û–ø–∏—à–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–∏ —Ç—É–∫..."):
    # UI: –ø–æ–∫–∞–∑–≤–∞–º–µ —Å–∞–º–æ –Ω–∞–ø–∏—Å–∞–Ω–æ—Ç–æ
    st.session_state.chat_ui.append({"role": "user", "text": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    # Model: –¥–æ–±–∞–≤—è–º–µ —Å–∫—Ä–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç
    full_prompt = f"[–°–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç: {specialty}] {prompt}"
    st.session_state.chat_model.append({"role": "user", "parts": [full_prompt]})

    detailed_by_ui = (verbosity_mode == "–ü–æ–¥—Ä–æ–±–Ω–æ (–ø–æ –∑–∞—è–≤–∫–∞)")
    detailed_by_text = user_requests_detail(prompt)
    is_detailed = detailed_by_ui or detailed_by_text

    with st.chat_message("assistant"):
        with st.spinner("EcoAI –∞–Ω–∞–ª–∏–∑–∏—Ä–∞..."):
            try:
                model = genai.GenerativeModel(
                    model_name="gemini-2.5-flash",
                    system_instruction=SYSTEM_PROMPT,
                    generation_config=get_gen_config(is_detailed),
                )

                response = model.generate_content(st.session_state.chat_model)
                answer = extract_text(response)

                # –ê–∫–æ –Ω—è–º–∞ —Ç–µ–∫—Å—Ç ‚Äî –ø–æ–∫–∞–∂–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ ‚Äû–ø—Ä–∞–∑–Ω–æ‚Äú
                if not answer:
                    st.warning("–ù—è–º–∞ –≤—ä—Ä–Ω–∞—Ç —Ç–µ–∫—Å—Ç –æ—Ç –º–æ–¥–µ–ª–∞. –í—ä–∑–º–æ–∂–Ω–æ –µ –±–ª–æ–∫–∏—Ä–∞–Ω–µ –∏–ª–∏ –ø—Ä–∞–∑–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä.")
                    # –ü–æ–∫–∞–∂–∏ –∫–∞–∫–≤–æ—Ç–æ –º–æ–∂–µ –¥–∞ —Å–µ –≤–∏–¥–∏ (–∞–∫–æ –∏–º–∞)
                    pf = getattr(response, "prompt_feedback", None)
                    if pf:
                        st.info(f"prompt_feedback: {pf}")
                    # –ù–µ –ø—Ä–µ–∫—ä—Å–≤–∞–º–µ, –Ω–æ –¥–∞–≤–∞–º–µ fallback —Å—ä–æ–±—â–µ–Ω–∏–µ
                    answer = (
                        "–ò–∑–≤–∏–Ω–µ—Ç–µ ‚Äî –Ω–µ —É—Å–ø—è—Ö –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–º —Å–º–∏—Å–ª–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä. "
                        "–û–ø–∏—Ç–∞–π—Ç–µ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ –ø–æ–≤–µ—á–µ –¥–µ—Ç–∞–π–ª–∏ (–ø—Ä–æ—Ü–µ—Å, –º–∞—Ç–µ—Ä–∏–∞–ª–∏, –µ–Ω–µ—Ä–≥–∏—è, –µ–º–∏—Å–∏–∏/–æ—Ç–ø–∞–¥—ä—Ü–∏) "
                        "–∏–ª–∏ –Ω–∞–ø–∏—à–µ—Ç–µ ‚Äû–ø–æ-–ø–æ–¥—Ä–æ–±–Ω–æ‚Äú.\n\n–ù–∏–≤–æ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç: 2/5"
                    )

                st.markdown(answer)

                # –ó–∞–ø–∏—Å–≤–∞–º–µ –≤ UI –∏ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∑–∞ –º–æ–¥–µ–ª–∞
                st.session_state.chat_ui.append({"role": "assistant", "text": answer})
                st.session_state.chat_model.append({"role": "model", "parts": [answer]})

            except Exception as e:
                st.error(f"–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ: {str(e)}")
